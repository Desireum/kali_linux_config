!function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function r(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function i(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function s(t,e){return s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},s(t,e)}function o(t){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o(t)}function n(t,e){if(e&&("object"===o(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return i(t)}function u(t){return u=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},u(t)}function h(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function a(t,e,r){return a=h()?Reflect.construct.bind():function(t,e,r){var i=[null];i.push.apply(i,e);var o=new(Function.bind.apply(t,i));return r&&s(o,r.prototype),o},a.apply(null,arguments)}function f(t){var e="function"==typeof Map?new Map:void 0;return f=function(t){if(null===t||(r=t,-1===Function.toString.call(r).indexOf("[native code]")))return t;var r;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,i)}function i(){return a(t,arguments,u(this).constructor)}return i.prototype=Object.create(t.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),s(i,t)},f(t)}function p(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}class c{constructor(){this._vector=new Float32Array,this._position=0,this._frameCount=0}get vector(){return this._vector}get position(){return this._position}get startIndex(){return 2*this._position}get frameCount(){return this._frameCount}get endIndex(){return 2*(this._position+this._frameCount)}clear(){this.receive(this._frameCount),this.rewind()}put(t){this._frameCount+=t}putSamples(t,e,r=0){const i=2*(e=e||0);r>=0||(r=(t.length-i)/2);const s=2*r;this.ensureCapacity(r+this._frameCount);const o=this.endIndex;this.vector.set(t.subarray(i,i+s),o),this._frameCount+=r}putBuffer(t,e,r=0){e=e||0,r>=0||(r=t.frameCount-e),this.putSamples(t.vector,t.position+e,r)}receive(t){t>=0&&!(t>this._frameCount)||(t=this.frameCount),this._frameCount-=t,this._position+=t}receiveSamples(t,e=0){const r=2*e,i=this.startIndex;t.set(this._vector.subarray(i,i+r)),this.receive(e)}extract(t,e=0,r=0){const i=this.startIndex+2*e,s=2*r;t.set(this._vector.subarray(i,i+s))}ensureCapacity(t=0){const e=parseInt(2*t);if(this._vector.length<e){const t=new Float32Array(e);t.set(this._vector.subarray(this.startIndex,this.endIndex)),this._vector=t,this._position=0}else this.rewind()}ensureAdditionalCapacity(t=0){this.ensureCapacity(this._frameCount+t)}rewind(){this._position>0&&(this._vector.set(this._vector.subarray(this.startIndex,this.endIndex)),this._position=0)}}class l{constructor(t){t?(this._inputBuffer=new c,this._outputBuffer=new c):this._inputBuffer=this._outputBuffer=null}get inputBuffer(){return this._inputBuffer}set inputBuffer(t){this._inputBuffer=t}get outputBuffer(){return this._outputBuffer}set outputBuffer(t){this._outputBuffer=t}clear(){this._inputBuffer.clear(),this._outputBuffer.clear()}}class m extends l{constructor(t){super(t),this.reset(),this._rate=1}set rate(t){this._rate=t}reset(){this.slopeCount=0,this.prevSampleL=0,this.prevSampleR=0}clone(){const t=new m;return t.rate=this._rate,t}process(){const t=this._inputBuffer.frameCount;this._outputBuffer.ensureAdditionalCapacity(t/this._rate+1);const e=this.transpose(t);this._inputBuffer.receive(),this._outputBuffer.put(e)}transpose(t=0){if(0===t)return 0;const e=this._inputBuffer.vector,r=this._inputBuffer.startIndex,i=this._outputBuffer.vector,s=this._outputBuffer.endIndex;let o=0,n=0;for(;this.slopeCount<1;)i[s+2*n]=(1-this.slopeCount)*this.prevSampleL+this.slopeCount*e[r],i[s+2*n+1]=(1-this.slopeCount)*this.prevSampleR+this.slopeCount*e[r+1],n+=1,this.slopeCount+=this._rate;if(this.slopeCount-=1,1!==t)t:for(;;){for(;this.slopeCount>1;)if(this.slopeCount-=1,o+=1,o>=t-1)break t;const u=r+2*o;i[s+2*n]=(1-this.slopeCount)*e[u]+this.slopeCount*e[u+2],i[s+2*n+1]=(1-this.slopeCount)*e[u+1]+this.slopeCount*e[u+3],n+=1,this.slopeCount+=this._rate}return this.prevSampleL=e[r+2*t-2],this.prevSampleR=e[r+2*t-1],n}}const v=[[124,186,248,310,372,434,496,558,620,682,744,806,868,930,992,1054,1116,1178,1240,1302,1364,1426,1488,0],[-100,-75,-50,-25,25,50,75,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-20,-15,-10,-5,5,10,15,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-4,-3,-2,-1,1,2,3,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];class _ extends l{constructor(t){super(t),this._quickSeek=!0,this.midBufferDirty=!1,this.midBuffer=null,this.overlapLength=0,this.autoSeqSetting=!0,this.autoSeekSetting=!0,this._tempo=1,this.setParameters(44100,0,0,8)}clear(){super.clear(),this.clearMidBuffer()}clearMidBuffer(){this.midBufferDirty&&(this.midBufferDirty=!1,this.midBuffer=null)}setParameters(t,e,r,i){t>0&&(this.sampleRate=t),i>0&&(this.overlapMs=i),e>0?(this.sequenceMs=e,this.autoSeqSetting=!1):this.autoSeqSetting=!0,r>0?(this.seekWindowMs=r,this.autoSeekSetting=!1):this.autoSeekSetting=!0,this.calculateSequenceParameters(),this.calculateOverlapLength(this.overlapMs),this.tempo=this._tempo}set tempo(t){let e;this._tempo=t,this.calculateSequenceParameters(),this.nominalSkip=this._tempo*(this.seekWindowLength-this.overlapLength),this.skipFract=0,e=Math.floor(this.nominalSkip+.5),this.sampleReq=Math.max(e+this.overlapLength,this.seekWindowLength)+this.seekLength}get tempo(){return this._tempo}get inputChunkSize(){return this.sampleReq}get outputChunkSize(){return this.overlapLength+Math.max(0,this.seekWindowLength-2*this.overlapLength)}calculateOverlapLength(t=0){let e;e=this.sampleRate*t/1e3,e=e<16?16:e,e-=e%8,this.overlapLength=e,this.refMidBuffer=new Float32Array(2*this.overlapLength),this.midBuffer=new Float32Array(2*this.overlapLength)}checkLimits(t,e,r){return t<e?e:t>r?r:t}calculateSequenceParameters(){let t,e;this.autoSeqSetting&&(t=150+-50*this._tempo,t=this.checkLimits(t,50,125),this.sequenceMs=Math.floor(t+.5)),this.autoSeekSetting&&(e=28.333333333333332+-6.666666666666667*this._tempo,e=this.checkLimits(e,15,25),this.seekWindowMs=Math.floor(e+.5)),this.seekWindowLength=Math.floor(this.sampleRate*this.sequenceMs/1e3),this.seekLength=Math.floor(this.sampleRate*this.seekWindowMs/1e3)}set quickSeek(t){this._quickSeek=t}clone(){const t=new _;return t.tempo=this._tempo,t.setParameters(this.sampleRate,this.sequenceMs,this.seekWindowMs,this.overlapMs),t}seekBestOverlapPosition(){return this._quickSeek?this.seekBestOverlapPositionStereoQuick():this.seekBestOverlapPositionStereo()}seekBestOverlapPositionStereo(){let t,e,r,i=0;for(this.preCalculateCorrelationReferenceStereo(),t=0,e=Number.MIN_VALUE;i<this.seekLength;i+=1)r=this.calculateCrossCorrelationStereo(2*i,this.refMidBuffer),r>e&&(e=r,t=i);return t}seekBestOverlapPositionStereoQuick(){let t,e,r,i,s,o=0;for(this.preCalculateCorrelationReferenceStereo(),e=Number.MIN_VALUE,t=0,i=0,s=0;o<4;o+=1){let n=0;for(;v[o][n]&&(s=i+v[o][n],!(s>=this.seekLength));)r=this.calculateCrossCorrelationStereo(2*s,this.refMidBuffer),r>e&&(e=r,t=s),n+=1;i=t}return t}preCalculateCorrelationReferenceStereo(){let t,e,r=0;for(;r<this.overlapLength;r+=1)e=r*(this.overlapLength-r),t=2*r,this.refMidBuffer[t]=this.midBuffer[t]*e,this.refMidBuffer[t+1]=this.midBuffer[t+1]*e}calculateCrossCorrelationStereo(t,e){const r=this._inputBuffer.vector;t+=this._inputBuffer.startIndex;let i=0,s=2;const o=2*this.overlapLength;let n;for(;s<o;s+=2)n=s+t,i+=r[n]*e[s]+r[n+1]*e[s+1];return i}overlap(t){this.overlapStereo(2*t)}overlapStereo(t){const e=this._inputBuffer.vector;t+=this._inputBuffer.startIndex;const r=this._outputBuffer.vector,i=this._outputBuffer.endIndex;let s,o,n=0;const u=1/this.overlapLength;let h,a,f;for(;n<this.overlapLength;n+=1)o=(this.overlapLength-n)*u,h=n*u,s=2*n,a=s+t,f=s+i,r[f+0]=e[a+0]*h+this.midBuffer[s+0]*o,r[f+1]=e[a+1]*h+this.midBuffer[s+1]*o}process(){let t,e,r;if(null===this.midBuffer){if(this._inputBuffer.frameCount<this.overlapLength)return;this.midBuffer=new Float32Array(2*this.overlapLength),this._inputBuffer.receiveSamples(this.midBuffer,this.overlapLength)}for(;this._inputBuffer.frameCount>=this.sampleReq;){t=this.seekBestOverlapPosition(),this._outputBuffer.ensureAdditionalCapacity(this.overlapLength),this.overlap(Math.floor(t)),this._outputBuffer.put(this.overlapLength),e=this.seekWindowLength-2*this.overlapLength,e>0&&this._outputBuffer.putBuffer(this._inputBuffer,t+this.overlapLength,e);const i=this._inputBuffer.startIndex+2*(t+this.seekWindowLength-this.overlapLength);this.midBuffer.set(this._inputBuffer.vector.subarray(i,i+2*this.overlapLength)),this.skipFract+=this.nominalSkip,r=Math.floor(this.skipFract),this.skipFract-=r,this._inputBuffer.receive(r)}}}const d=function(t,e){return(t>e?t-e:e-t)>1e-10};class B{constructor(){this.transposer=new m(!1),this.stretch=new _(!1),this._inputBuffer=new c,this._intermediateBuffer=new c,this._outputBuffer=new c,this._rate=0,this._tempo=0,this.virtualPitch=1,this.virtualRate=1,this.virtualTempo=1,this.calculateEffectiveRateAndTempo()}clear(){this.transposer.clear(),this.stretch.clear()}clone(){const t=new B;return t.rate=this.rate,t.tempo=this.tempo,t}get rate(){return this._rate}set rate(t){this.virtualRate=t,this.calculateEffectiveRateAndTempo()}set rateChange(t){this._rate=1+.01*t}get tempo(){return this._tempo}set tempo(t){this.virtualTempo=t,this.calculateEffectiveRateAndTempo()}set tempoChange(t){this.tempo=1+.01*t}set pitch(t){this.virtualPitch=t,this.calculateEffectiveRateAndTempo()}set pitchOctaves(t){this.pitch=Math.exp(.69314718056*t),this.calculateEffectiveRateAndTempo()}set pitchSemitones(t){this.pitchOctaves=t/12}get inputBuffer(){return this._inputBuffer}get outputBuffer(){return this._outputBuffer}calculateEffectiveRateAndTempo(){const t=this._tempo,e=this._rate;this._tempo=this.virtualTempo/this.virtualPitch,this._rate=this.virtualRate*this.virtualPitch,d(this._tempo,t)&&(this.stretch.tempo=this._tempo),d(this._rate,e)&&(this.transposer.rate=this._rate),this._rate>1?this._outputBuffer!=this.transposer.outputBuffer&&(this.stretch.inputBuffer=this._inputBuffer,this.stretch.outputBuffer=this._intermediateBuffer,this.transposer.inputBuffer=this._intermediateBuffer,this.transposer.outputBuffer=this._outputBuffer):this._outputBuffer!=this.stretch.outputBuffer&&(this.transposer.inputBuffer=this._inputBuffer,this.transposer.outputBuffer=this._intermediateBuffer,this.stretch.inputBuffer=this._intermediateBuffer,this.stretch.outputBuffer=this._outputBuffer)}process(){this._rate>1?(this.stretch.process(),this.transposer.process()):(this.transposer.process(),this.stretch.process())}}var g=function(e){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&s(t,e)}(f,e);var o,h,a=(o=f,h=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=u(o);if(h){var r=u(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return n(this,t)});function f(){var e;return t(this,f),p(i(e=a.call(this)),"soundTouch",new B),p(i(e),"filter",new y(e.soundTouch)),p(i(e),"semitone",void 0),p(i(e),"outputBuffer",void 0),p(i(e),"released",void 0),e.port.onmessage=function(t){"RELEASE"===t.data.type&&(e.released=!0,delete e.soundTouch,delete e.filter)},e}return r(f,[{key:"process",value:function(t,e,r){var i,s;if(this.released)return!1;var o=t[0],n=e[0];if(!o[0])return!0;var u=o[0].length,h=o.length>1,a=null!==(i=r.semitone[0])&&void 0!==i?i:0;if(this.semitone!==a&&(this.soundTouch.pitchSemitones=a,this.semitone=a),0===this.semitone){for(var f=0;f<o.length;f++)n[f].set(o[f]);return!0}if(this.outputBuffer=(null===(s=this.outputBuffer)||void 0===s?void 0:s.length)===2*u?this.outputBuffer:new Float32Array(2*u),this.filter.push(o[0],o[1]||o[0]),this.filter.extract(this.outputBuffer,u),h)for(var p=0;p<u;p++)n[0][p]=this.outputBuffer[2*p]||0,n[1][p]=this.outputBuffer[2*p+1]||0;else for(var c=0;c<u;c++)n[0][c]=this.outputBuffer[2*c]||0;return!0}}],[{key:"parameterDescriptors",get:function(){return[{name:"semitone",defaultValue:0,automationRate:"k-rate"}]}}]),f}(f(AudioWorkletProcessor)),y=function(){function e(r){t(this,e),this._pipe=r}return r(e,[{key:"push",value:function(t,e){for(var r=new Float32Array(2*t.length),i=0;i<t.length;i++)r[2*i]=t[i],r[2*i+1]=e[i];this._pipe.inputBuffer.putSamples(r,0,t.length)}},{key:"extract",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8192;this._pipe.inputBuffer.frameCount>=r&&this._pipe.process(),this._pipe.outputBuffer.receiveSamples(t,e)}}]),e}();registerProcessor("sound-touch-processor",g)}();